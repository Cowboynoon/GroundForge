# [DEMO](https://d-bl.github.io/GroundForge/)
A toolbox to design bobbin lace grounds with matching diagrams.

How it's Made / Under the Hood
==============================

Proof of concept with D3.js
---------------------------

To get a proof of concept a force graph [example] with originally v3 of [D3.js] was changed into tiny thread an pair diagrams diagrams with the following steps:

- Replaced the server side JSon with the hard-coded [js/sample.js] assembled from a manual sketch [js/sample.png].
- Applied arrow heads and flattened them to line ends to emulate [color coded pair diagrams] or to emulate the over/under effect in thread diagrams. Later versions create the over/under effect with shortened lines, for better browser support and performance, a too complicated approach for the multiple colors of a color coded diagram.
- Made nodes transparent except for bobbins.
- Assigned the thread number as a class to each section of a thread to assign colors.
- Turned the links from lines to paths with a third node to add mid-markers for twist marks.
- Initial coordinates replace the default random values, thus the animation stabalizes much quicker which prevents rotated and flipped diagrams.

[example]: http://bl.ocks.org/mbostock/4062045
[D3.js]: http://d3js.org/
[js/sample.js]: https://github.com/d-bl/GroundForge/blob/7a94b670636a138b1f417c0640561bfb1cbc5fc7/js/sample.js
[js/sample.png]: https://github.com/d-bl/GroundForge/blob/50421a210ee28c73bcdddbc997802d48128ce6b9/js/sample.png
[color coded pair diagrams]: https://en.wikipedia.org/w/index.php?title=Mesh_grounded_bobbin_lace&oldid=639789191#Worker_pair_versus_two_pair_per_pin


Using data from TesseLace
-------------------------

To provide alternatives for the `js/sample.js` above, `src/maini/scala` compiled into `docs/js/matrix-graphs.js` transforms a selection of matrices generated by [TesseLace.com].
The initial [proof of concept] was created by hand using a [sketch].
The data is computed from [matrices] resulting from scientific research presented at [TesseLace].
GroundForge uses a [compact] matrix format using one character defining the composition of incoming pairs to tag each node.

The geometric information within the matrices is used to initialise the thread diagrams, speeding up the animation as explained above.
These [pages] were used to create the thumbnails.
The diagrams lack the original geometric information after completion of the animation,
so topological duplicates were removed from the generated thumbnails.
Downloadable pattern sheets provide geometric variations that can be customised into intermediate and other variations.

The thread diagrams are not generated from the matrices,
but from the generated JSon data for pair diagrams by replacing nodes with stitches.
To keep track of the threads while constructing the diagram, 
the algorithm has to figure out a working order to create the lace just like a real lace maker does.

[pages]: https://github.com/d-bl/GroundForge/blob/master/src/test/resources/
[compact]: https://d-bl.github.io/GroundForge/images/legend.png
[TesseLace.com]: http://TesseLace.com
[matrices]: https://github.com/d-bl/GroundForge/blob/22f607724dd2bb5e8dd5d315d3fe5fbfdc8c9039/images/legend.png
[proof of concept]: https://cdn.rawgit.com/d-bl/GroundForge/84eee36324e448bf16c12dec08b55bf4814bedb0/index.html
[sketch]: https://github.com/d-bl/GroundForge/commit/f358191e441449fdd7096ecf8dbed4e0a0ca79ba


Color-picker: jscolor
---------------------

Safari nor Internet Explorer support `<input type="color">`. The free [color-picker](http://jscolor.com/) works on both platforms and was easy to apply.


Scala code
==========

Event handling (`index.js` and `jscolor.js`) and calling the [D3.js] API (`show-graphs.js`) is done with JavaScript. The number crunching assembling the data for D3js and assembling the SVG for the pattern sheet is written in Scala.

Compile and preview
-------------------

### Requirements

- [sbt] 0.13.7 or higher, to compile the source code to java script
- [maven], to run the test with another JVM than scala was built with
- a browser with proper SVG support, for example FireFox or Safari but not Internet Explorer.
  Chrome has proper SVG support but with the default settings it has intranet problems with the development view.

To completely [replace sbt] seems quite a detour.

[replace sbt]: http://stackoverflow.com/questions/26512750/how-to-use-scala-js-from-maven
[sbt]: http://www.scala-sbt.org/download.html
[maven]: https://maven.apache.org/


### Steps

- Fork the project an make a local clone.
- Avoid working on the master branch, rather create branches and pull requests.
- Go to the root of the local project and start the command `sbt ~fastOptJS`
- Monitor the result on `http://localhost:12345/target/scala-2.11/classes/index-dev.html`
  It is a dressed down version of the demo page, with experimental features added.
  Nodes and links invisible in the demo page are shown faint for debugging purposes.
- Saving code changes updates the page automatically but not completely properly.


Important code conventions
--------------------------

- Don't catch exceptions in a `Try` but prevent them to create a `Failure` for safe execution with JavaScript.
- Restrict the use of raw js objects to the API: the classes and methods annotated with `@JSExport`. This allows execution of test classes with another JVM than ScalaJS was built with.

The applied Scala coding techniques are explained by this [course] up and including workshop 3, except that the main code doesn't use any io, and the simple io in the test code doesn't justify the use of any library. 

[course]: https://github.com/DANS-KNAW/course-scala


Unit tests
----------

The command `sbt test` only compiles the test classes.
Haven't found the proper incantation to execute the test with sbt, might be caused by a dependency conflict.

The command `mvn clean test` executes the tests, your IDE might too.

Launching tests with the IDE while sbt is still processing a change may cause weird errors, just try again.


Publish
-------

- Compile with `sbt ~fullOptJS`
- Copy the content of `target\scala-2.11\groundforge-opt.js` in the master branch
  into `docs/js/matrix-graphs.js`
- Check the results with `index.html`
- If ok: commit, push and check the online demo in your own github fork: `http://YOURID.github.io/GroundForge/`
- Create a pull request
